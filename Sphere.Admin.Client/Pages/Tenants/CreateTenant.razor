@page "/tenants/create"
@inject ApiService ApiService
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Nueva Empresa - Sphere Admin</PageTitle>

<!-- Header -->
<MudContainer MaxWidth="MaxWidth.False" Class="mb-4">
    <div class="d-flex align-center">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                     Color="Color.Primary" 
                     Href="/tenants"
                     Class="mr-3" />
        <div>
            <MudText Typo="Typo.h4" Class="mud-text-primary font-weight-bold">
                Registrar Nueva Empresa
            </MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
                Completa la información para crear una nueva empresa en Sphere
            </MudText>
        </div>
    </div>
</MudContainer>

<!-- Form -->
<MudContainer MaxWidth="MaxWidth.Large">
    <MudCard Elevation="4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Información de la Empresa</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <EditForm Model="@_createModel" OnValidSubmit="@HandleCreateTenant">
                <DataAnnotationsValidator />
                
                <MudGrid>
                    <!-- Información Básica -->
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-4 mud-text-primary">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
                            Información Básica
                        </MudText>
                    </MudItem>

                    <!-- Código de Empresa -->
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createModel.Code"
                                    For="@(() => _createModel.Code)"
                                    Label="Código de Empresa"
                                    Placeholder="ej: empresa-abc"
                                    Variant="Variant.Outlined"
                                    HelperText="Código único para identificar la empresa (sin espacios, solo letras, números y guiones)"
                                    OnBlur="@ValidateCode"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Tag"
                                    FullWidth="true"
                                    Disabled="@_isLoading" />
                        @if (_codeValidationMessage != null)
                        {
                            <MudText Typo="Typo.caption" Color="@(_isCodeValid ? Color.Success : Color.Error)">
                                @_codeValidationMessage
                            </MudText>
                        }
                    </MudItem>

                    <!-- Nombre de Empresa -->
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createModel.Name"
                                    For="@(() => _createModel.Name)"
                                    Label="Nombre de la Empresa"
                                    Placeholder="ej: Empresa ABC S.L."
                                    Variant="Variant.Outlined"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Business"
                                    FullWidth="true"
                                    Disabled="@_isLoading" />
                    </MudItem>

                    <!-- Email de Contacto -->
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createModel.ContactEmail"
                                    For="@(() => _createModel.ContactEmail)"
                                    Label="Email de Contacto"
                                    Placeholder="admin@empresa.com"
                                    Variant="Variant.Outlined"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Email"
                                    FullWidth="true"
                                    Disabled="@_isLoading" />
                    </MudItem>

                    <!-- Teléfono de Contacto -->
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_createModel.ContactPhone"
                                    For="@(() => _createModel.ContactPhone)"
                                    Label="Teléfono de Contacto"
                                    Placeholder="+34 XXX XXX XXX"
                                    Variant="Variant.Outlined"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Phone"
                                    FullWidth="true"
                                    Disabled="@_isLoading" />
                    </MudItem>

                    <!-- Configuración de Licencia -->
                    <MudItem xs="12" Class="mt-6">
                        <MudText Typo="Typo.h6" Class="mb-4 mud-text-primary">
                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Class="mr-2" />
                            Configuración de Licencia
                        </MudText>
                    </MudItem>

                    <!-- Tipo de Licencia -->
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="_createModel.LicenseType"
                                 For="@(() => _createModel.LicenseType)"
                                 Label="Tipo de Licencia"
                                 Variant="Variant.Outlined"
                                 AnchorOrigin="Origin.BottomCenter"
                                 FullWidth="true"
                                 Disabled="@_isLoading">
                            <MudSelectItem Value="@("Trial")">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-2" Color="Color.Warning" />
                                    Trial (30 días gratis)
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@("Basic")">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Star" Class="mr-2" Color="Color.Info" />
                                    Basic (€9.99/mes)
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@("Professional")">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.StarRate" Class="mr-2" Color="Color.Primary" />
                                    Professional (€19.99/mes)
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@("Enterprise")">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Diamond" Class="mr-2" Color="Color.Secondary" />
                                    Enterprise (€39.99/mes)
                                </div>
                            </MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Máximo de Empleados -->
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="_createModel.MaxEmployees"
                                       For="@(() => _createModel.MaxEmployees)"
                                       Label="Máximo de Empleados"
                                       Variant="Variant.Outlined"
                                       Min="1"
                                       Max="10000"
                                       Step="1"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.People"
                                       HelperText="@GetEmployeeLimitHelperText()"
                                       FullWidth="true"
                                       Disabled="@_isLoading" />
                    </MudItem>

                    <!-- License Info Card -->
                    <MudItem xs="12" Class="mt-4">
                        @if (!string.IsNullOrEmpty(_createModel.LicenseType))
                        {
                            <MudCard Elevation="2" Class="mud-theme-primary">
                                <MudCardContent>
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@GetLicenseIcon(_createModel.LicenseType)" 
                                               Color="@GetLicenseColor(_createModel.LicenseType)" 
                                               Class="mr-4" 
                                               Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.h6" Class="font-weight-bold">
                                                Plan @_createModel.LicenseType
                                            </MudText>
                                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                                @GetLicenseDescription(_createModel.LicenseType)
                                            </MudText>
                                        </div>
                                    </div>
                                </MudCardContent>
                            </MudCard>
                        }
                    </MudItem>

                    <!-- Validation Summary -->
                    <MudItem xs="12" Class="mt-4">
                        <ValidationSummary />
                    </MudItem>

                    <!-- Actions -->
                    <MudItem xs="12" Class="mt-6">
                        <div class="d-flex justify-end gap-4">
                            <MudButton Variant="Variant.Text" 
                                     Href="/tenants"
                                     Disabled="@_isLoading">
                                Cancelar
                            </MudButton>
                            <MudButton ButtonType="ButtonType.Submit"
                                     Variant="Variant.Filled"
                                     Color="Color.Primary"
                                     StartIcon="@Icons.Material.Filled.Save"
                                     Disabled="@(_isLoading || !_isCodeValid)"
                                     Size="Size.Large">
                                @if (_isLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Creando empresa...</span>
                                }
                                else
                                {
                                    <span>Crear Empresa</span>
                                }
                            </MudButton>
                        </div>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private readonly CreateTenantModel _createModel = new();
    private bool _isLoading = false;
    private bool _isCodeValid = false;
    private string? _codeValidationMessage;

    private async Task HandleCreateTenant()
    {
        try
        {
            _isLoading = true;

            var request = new CreateTenantRequest(
                _createModel.Code,
                _createModel.Name,
                _createModel.ContactEmail,
                _createModel.ContactPhone,
                _createModel.LicenseType,
                _createModel.MaxEmployees
            );

            var tenant = await ApiService.CreateTenantAsync(request);
            
            if (tenant != null)
            {
                NotificationService.ShowSuccess($"Empresa '{_createModel.Name}' creada correctamente");
                Navigation.NavigateTo("/tenants");
            }
            else
            {
                NotificationService.ShowError("Error al crear la empresa");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Error al crear la empresa");
            Console.WriteLine($"Error creating tenant: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ValidateCode()
    {
        if (string.IsNullOrWhiteSpace(_createModel.Code))
        {
            _codeValidationMessage = null;
            _isCodeValid = false;
            return;
        }

        // Validación de formato
        if (!System.Text.RegularExpressions.Regex.IsMatch(_createModel.Code, @"^[a-zA-Z0-9-_]+$"))
        {
            _codeValidationMessage = "El código solo puede contener letras, números, guiones y guiones bajos";
            _isCodeValid = false;
            return;
        }

        // TODO: Validar que el código no exista (cuando esté implementado en el backend)
        _codeValidationMessage = "Código disponible";
        _isCodeValid = true;
    }

    private string GetEmployeeLimitHelperText()
    {
        return _createModel.LicenseType switch
        {
            "Trial" => "Máximo 5 empleados para plan Trial",
            "Basic" => "Máximo 25 empleados para plan Basic",
            "Professional" => "Máximo 100 empleados para plan Professional",
            "Enterprise" => "Sin límite para plan Enterprise",
            _ => "Selecciona un tipo de licencia"
        };
    }

    private string GetLicenseIcon(string licenseType)
    {
        return licenseType switch
        {
            "Trial" => Icons.Material.Filled.Schedule,
            "Basic" => Icons.Material.Filled.Star,
            "Professional" => Icons.Material.Filled.StarRate,
            "Enterprise" => Icons.Material.Filled.Diamond,
            _ => Icons.Material.Filled.Help
        };
    }

    private Color GetLicenseColor(string licenseType)
    {
        return licenseType switch
        {
            "Trial" => Color.Warning,
            "Basic" => Color.Info,
            "Professional" => Color.Primary,
            "Enterprise" => Color.Secondary,
            _ => Color.Default
        };
    }

    private string GetLicenseDescription(string licenseType)
    {
        return licenseType switch
        {
            "Trial" => "30 días gratis para probar todas las funciones. Máximo 5 empleados.",
            "Basic" => "Plan básico con funciones esenciales. €9.99/mes, máximo 25 empleados.",
            "Professional" => "Plan completo con funciones avanzadas. €19.99/mes, máximo 100 empleados.",
            "Enterprise" => "Plan empresarial sin límites. €39.99/mes, empleados ilimitados.",
            _ => "Selecciona un tipo de licencia para ver los detalles"
        };
    }

    protected override void OnInitialized()
    {
        // Valores por defecto
        _createModel.LicenseType = "Trial";
        _createModel.MaxEmployees = 5;
    }

    public class CreateTenantModel
    {
        [Required(ErrorMessage = "El código de empresa es requerido")]
        [MinLength(3, ErrorMessage = "El código debe tener al menos 3 caracteres")]
        [MaxLength(50, ErrorMessage = "El código no puede tener más de 50 caracteres")]
        public string Code { get; set; } = string.Empty;

        [Required(ErrorMessage = "El nombre de la empresa es requerido")]
        [MinLength(2, ErrorMessage = "El nombre debe tener al menos 2 caracteres")]
        [MaxLength(100, ErrorMessage = "El nombre no puede tener más de 100 caracteres")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "El email de contacto es requerido")]
        [EmailAddress(ErrorMessage = "Formato de email inválido")]
        public string ContactEmail { get; set; } = string.Empty;

        [Phone(ErrorMessage = "Formato de teléfono inválido")]
        public string ContactPhone { get; set; } = string.Empty;

        [Required(ErrorMessage = "El tipo de licencia es requerido")]
        public string LicenseType { get; set; } = string.Empty;

        [Required(ErrorMessage = "El máximo de empleados es requerido")]
        [Range(1, 10000, ErrorMessage = "El número de empleados debe estar entre 1 y 10000")]
        public int MaxEmployees { get; set; } = 5;
    }
}