@using Shared.Models.DTOs.Auth
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject AuthService AuthService
@implements IDisposable

<MudThemeProvider @ref="@_mudThemeProvider" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    @if (_isAuthenticated)
    {
        <!-- Drawer/Sidebar -->
        <MudDrawer @bind-Open="_drawerOpen" 
                   Elevation="2" 
                   Width="280px" 
                   ClipMode="DrawerClipMode.Always">
            <NavMenu />
        </MudDrawer>

        <!-- AppBar -->
        <MudAppBar Elevation="4" Color="Color.Primary">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                         Color="Color.Inherit" 
                         Edge="Edge.Start" 
                         OnClick="@ToggleDrawer" />
            
            <MudSpacer />
            
            <MudMenu Icon="@Icons.Material.Filled.AccountCircle" 
                     Color="Color.Inherit">
                <ChildContent>
                    <div class="px-4 py-2">
                        <MudText Typo="Typo.subtitle2">@(_userInfo?.DisplayName ?? "Usuario")</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@_userInfo?.Email</MudText>
                    </div>
                    <MudDivider />
                    <MudMenuItem OnClick="GoToProfile" Icon="@Icons.Material.Filled.Person">
                        Mi Perfil
                    </MudMenuItem>
                    <MudMenuItem OnClick="GoToSettings" Icon="@Icons.Material.Filled.Settings">
                        Configuración
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="HandleLogout" Icon="@Icons.Material.Filled.Logout">
                        Cerrar Sesión
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>

        <!-- Main Content -->
        <MudMainContent Class="pa-4">
            @Body
        </MudMainContent>
    }
    else
    {
        <!-- Layout para páginas sin autenticación -->
        <MudMainContent>
            @Body
        </MudMainContent>
    }
</MudLayout>

@code {
    private MudThemeProvider? _mudThemeProvider;
    private bool _drawerOpen = true;
    private bool _isAuthenticated = false;
    private UserInfo? _userInfo;

    private readonly MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#1976d2",
            Secondary = "#424242",
            AppbarBackground = "#1976d2",
            Background = "#f5f5f5",
            DrawerBackground = "#ffffff",
            DrawerText = "rgba(0,0,0, 0.87)",
            Success = "#4caf50"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#90caf9",
            Secondary = "#ce93d8",
            AppbarBackground = "#1976d2",
            Background = "#121212",
            DrawerBackground = "#1e1e1e",
            DrawerText = "rgba(255,255,255, 0.87)"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        _isAuthenticated = await AuthService.IsAuthenticatedAsync();
        
        if (_isAuthenticated)
        {
            _userInfo = await AuthService.GetUserInfoAsync();
        }

        AuthService.AuthStateChanged += OnAuthStateChanged;
    }

    private void OnAuthStateChanged(bool isAuthenticated)
    {
        _isAuthenticated = isAuthenticated;
        
        if (isAuthenticated)
        {
            InvokeAsync(async () =>
            {
                _userInfo = await AuthService.GetUserInfoAsync();
                StateHasChanged();
            });
        }
        else
        {
            _userInfo = null;
            StateHasChanged();
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void GoToProfile()
    {
        // TODO: Implementar página de perfil
    }

    private void GoToSettings()
    {
        // TODO: Implementar página de configuración
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
    }

    public void Dispose()
    {
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
}